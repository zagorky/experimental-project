name: Deploy Discord notifier
on:
  push:
    branches: [ main, master ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Netlify deploy
        id: netlify
        uses: jakejarvis/wait-for-netlify-action@v1
        with:
          site_id: ${{ secrets.NETLIFY_SITE_ID }}
          token: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          timeout: '600'

      - name: Send Discord notification
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Deploy Bot",
              "avatar_url": "https://www.netlify.com/img/press/logos/logomark.png",
              "embeds": [{
                "title": "üöÄ –ù–æ–≤—ã–π –¥–µ–ø–ª–æ–π",
                "color": 5763719,
                "fields": [
                  {"name": "–ü—Ä–æ–µ–∫—Ç", "value": "${{ steps.netlify.outputs.name }}"},
                  {"name": "–°—Ç–∞—Ç—É—Å", "value": "–£—Å–ø–µ—à–Ω–æ", "inline": true},
                  {"name": "–í–µ—Ç–∫–∞", "value": "${{ github.ref_name }}", "inline": true},
                  {"name": "–°—Å—ã–ª–∫–∞", "value": "[–û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç](${{ steps.netlify.outputs.url }})"},
                  {"name": "–õ–æ–≥–∏", "value": "[–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å](${{ steps.netlify.outputs.admin_url }})"}
                ],
                "timestamp": "${{ steps.netlify.outputs.created_at }}"
              }]
            }' \
            "${{ secrets.DISCORD_DEPLOY_WEBHOOK_URL }}"

      - name: Handle deploy failure
        if: failure()
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "content": "‚ùå –î–µ–ø–ª–æ–π –Ω–µ —É–¥–∞–ª—Å—è! \n–í–µ—Ç–∫–∞: ${{ github.ref_name }}\n–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
            }' \
            "${{ secrets.DISCORD_DEPLOY_WEBHOOK_URL }}"
